#!/usr/bin/env ruby

$:.unshift(File.expand_path("../../lib", __FILE__))
require 'reskype'

def usage
  puts "USAGE: ruby bin/parse SKYPE_DIR TARGET_DIR"
  puts
  puts "on OSX SKYPE_DIR is likely to be /Users/dan/Library/Application\ Support/Skype/URUSERNAME/"
  puts "TARGET_DIR is an existing, should be empty, directory where the parsed chat files will be placed"
  exit
end

if ARGV.include?("-h") or ARGV.include?("--help")
  usage
end

user_dir = ARGV[0]
unless user_dir and File.exist?(user_dir)
  puts "SKYPE_DIR not found"
  usage
end

target_dir = ARGV[1]
unless target_dir and File.exist?(target_dir) and File.directory?(target_dir)
  puts "TARGET_DIR not found"
  usage
end

main_db_paths = Dir[File.expand_path(user_dir) + "/*main.db"]

chats = []

main_db_paths.each do |main_db_path|
  puts main_db_path
  reskype5 = Reskype::Skype5.new(main_db_path)
  chats += Reskype.export(reskype5.chats)
end

reskype3 = Reskype::Skype3.new(user_dir)
chats += Reskype.export(reskype3.chats)

unless File.exist?(target_dir)
  raise
end
  
chats.each do |chat|
  filename = "chat__" + Reskype.chat_basename(chat)
  path = target_dir + "/" + filename
  while File.exist?(path+".json")
    if path =~ /-(\d+)$/
      path = path[0..(-1*$1.length - 1)] + ($1.to_i + 1).to_s
    else
      path += "-1"
    end
  end
  File.open(path+".json", "w") do |f|
    chat_info = Reskype.chat_to_hash(chat)
    begin
      f.puts JSON.pretty_generate(chat_info)
    rescue Encoding::UndefinedConversionError
      puts "undefined encoding error in #{chat.name}"
    end
  end
end



